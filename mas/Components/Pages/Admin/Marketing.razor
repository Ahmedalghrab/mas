@page "/admin/marketing"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@attribute [Authorize(Policy = "AdminOnly")]
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Marketing - ALMASS Admin</PageTitle>

<div class="container-fluid py-4" style="background-color: #f8f9fa;">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 text-dark fw-bold">
                <i class="bi bi-megaphone"></i> Marketing Management
            </h1>
            <p class="text-dark" style="font-size: 1.1rem; font-weight: 500;">Manage marketing campaigns via Email and WhatsApp</p>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4 border-0" role="tablist" style="background-color: #e9ecef; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <li class="nav-item me-2" role="presentation">
            <button class="nav-link active fw-bold" data-bs-toggle="tab" data-bs-target="#campaign-tab" 
                style="color: white; background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); border-radius: 8px; padding: 12px 24px; font-size: 1.1rem; border: none;">
                <i class="bi bi-send"></i> Ø¥Ø±Ø³Ø§Ù„ Ø­Ù…Ù„Ø©
            </button>
        </li>
        <li class="nav-item me-2" role="presentation">
            <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#customers-tab" 
                style="color: white; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border-radius: 8px; padding: 12px 24px; font-size: 1.1rem; border: none;">
                <i class="bi bi-people"></i> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" data-bs-toggle="tab" data-bs-target="#history-tab" 
                style="color: white; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border-radius: 8px; padding: 12px 24px; font-size: 1.1rem; border: none;">
                <i class="bi bi-clock-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ù…Ù„Ø§Øª
            </button>
        </li>
    </ul>
    
    <style>
        .nav-link:not(.active):hover {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            color: white !important;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        .nav-link.active {
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.5) !important;
            transform: translateY(-2px);
        }
    </style>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="campaign-tab">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h5 class="mb-0 fw-bold"><i class="bi bi-megaphone"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                        </div>
                        <div class="card-body">
                            <EditForm Model="@campaign" OnValidSubmit="@SendCampaign" FormName="campaignForm">
                                <!-- Target Audience Selection -->
                                <div class="mb-4 p-3 rounded" style="background-color: #e3f2fd; border: 2px solid #2196f3;">
                                    <h6 class="fw-bold mb-3" style="color: #1565c0; font-size: 1.1rem;">
                                        <i class="bi bi-bullseye"></i> Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold text-dark" style="font-size: 1rem;">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±</label>
                                            <select @bind="campaign.AudienceType" class="form-select">
                                                <option value="registered">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (@registeredCustomersCount)</option>
                                                <option value="active">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (@activeCustomersCount)</option>
                                                <option value="inactive">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·ÙŠÙ† (@inactiveCustomersCount)</option>
                                                <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ù…Ø³Ø¬Ù„ÙŠÙ† + Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø§Ù…Ø©)</option>
                                                <option value="custom">Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØµØµØ©</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold text-dark" style="font-size: 1rem;">Ù‚Ù†Ø§Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚</label>
                                            <select @bind="campaign.Channel" class="form-select">
                                                <option value="whatsapp">ÙˆØ§ØªØ³Ø§Ø¨ ÙÙ‚Ø·</option>
                                                <option value="email">Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙÙ‚Ø·</option>
                                                <option value="both">ÙƒÙ„Ø§Ù‡Ù…Ø§</option>
                                                <option value="social">Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§</option>
                                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    @if (campaign.AudienceType == "custom")
                                    {
                                        <div class="alert alert-info">
                                            <i class="bi bi-upload"></i> Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel/CSV ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ)
                                            <input type="file" class="form-control mt-2" accept=".xlsx,.csv" />
                                        </div>
                                    }
                                </div>

                                <!-- Campaign Template Selection -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark" style="font-size: 1rem;">
                                        <i class="bi bi-file-text text-primary"></i> Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                                    </label>
                                    <select @bind="selectedTemplate" @bind:after="LoadTemplate" class="form-select mb-2">
                                        <option value="">-- Ø§Ø®ØªØ± Ù‚Ø§Ù„Ø¨ Ø¬Ø§Ù‡Ø² --</option>
                                        <option value="welcome">ØªØ±Ø­ÙŠØ¨ Ø¨Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</option>
                                        <option value="offer">Ø¹Ø±Ø¶ Ø®Ø§Øµ</option>
                                        <option value="reminder">ØªØ°ÙƒÙŠØ±</option>
                                        <option value="thankyou">Ø´ÙƒØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø¨</option>
                                        <option value="abandoned">Ø³Ù„Ø© Ù…ØªØ±ÙˆÙƒØ©</option>
                                        <option value="custom">Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark" style="font-size: 1rem;">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù…Ù„Ø©</label>
                                    <InputText @bind-Value="campaign.Title" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark" style="font-size: 1rem;">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                                    <InputTextArea @bind-Value="campaign.MessageContent" class="form-control" rows="8" 
                                        placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§... ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù…: {Ø§Ù„Ø§Ø³Ù…} {Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨} {Ø±Ø§Ø¨Ø·_Ø§Ù„Ø¹Ø±Ø¶}"></InputTextArea>
                                    <small class="text-muted">
                                        <i class="bi bi-lightbulb"></i> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª: {Ø§Ù„Ø§Ø³Ù…}ØŒ {Ø§Ù„Ø¨Ø±ÙŠØ¯}ØŒ {Ø±Ù‚Ù…_Ø§Ù„Ù‡Ø§ØªÙ}ØŒ {Ø±Ø§Ø¨Ø·_Ø§Ù„Ù…ÙˆÙ‚Ø¹}
                                    </small>
                                </div>

                                <!-- Tracking & Social Media -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" @bind="campaign.TrackClicks" id="trackClicks">
                                            <label class="form-check-label" for="trackClicks">
                                                <i class="bi bi-graph-up"></i> ØªØªØ¨Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" @bind="campaign.GenerateQRCode" id="generateQR">
                                            <label class="form-check-label" for="generateQR">
                                                <i class="bi bi-qr-code"></i> Ø¥Ù†Ø´Ø§Ø¡ QR Code Ù„Ù„Ø­Ù…Ù„Ø©
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Social Media Sharing -->
                                @if (campaign.Channel == "social" || campaign.Channel == "all")
                                {
                                    <div class="mb-3 p-3 rounded" style="background-color: #fff3e0; border: 2px solid #ff9800;">
                                        <h6 class="fw-bold mb-3 text-dark" style="font-size: 1.05rem;"><i class="bi bi-share text-warning"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§</h6>
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary" @onclick="() => ShareToFacebook()">
                                                <i class="bi bi-facebook"></i> ÙÙŠØ³Ø¨ÙˆÙƒ
                                            </button>
                                            <button type="button" class="btn btn-outline-info" @onclick="() => ShareToTwitter()">
                                                <i class="bi bi-twitter"></i> ØªÙˆÙŠØªØ±
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" @onclick="() => ShareToInstagram()">
                                                <i class="bi bi-instagram"></i> Ø¥Ù†Ø³ØªÙ‚Ø±Ø§Ù…
                                            </button>
                                        </div>
                                    </div>
                                }

                                <!-- Scheduling -->
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-dark" style="font-size: 1rem;">
                                        <i class="bi bi-calendar-event text-success"></i> Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                                    </label>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select @bind="campaign.SendTiming" class="form-select">
                                                <option value="now">Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±ÙŠ</option>
                                                <option value="scheduled">Ø¬Ø¯ÙˆÙ„Ø©</option>
                                            </select>
                                        </div>
                                        @if (campaign.SendTiming == "scheduled")
                                        {
                                            <div class="col-md-6">
                                                <input type="datetime-local" @bind="campaign.ScheduledDate" class="form-control" />
                                            </div>
                                        }
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(campaignResult))
                                {
                                    <div class="alert @(campaignSuccess ? "alert-success" : "alert-danger")">
                                        <i class="bi @(campaignSuccess ? "bi-check-circle" : "bi-exclamation-triangle")"></i> 
                                        @campaignResult
                                    </div>
                                }

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg flex-fill" disabled="@sending">
                                        @if (sending)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        <i class="bi bi-send"></i> @(campaign.SendTiming == "scheduled" ? "Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø­Ù…Ù„Ø©" : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†")
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg" @onclick="SaveDraft">
                                        <i class="bi bi-save"></i> Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-lg" @onclick="PreviewCampaign">
                                        <i class="bi bi-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©
                                    </button>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Campaign Stats -->
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                            <h6 class="mb-0 fw-bold"><i class="bi bi-graph-up"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h6>
                        </div>
                        <div class="card-body" style="background-color: #f8f9fa;">
                            <div class="d-flex justify-content-between mb-3 p-2 rounded" style="background-color: white;">
                                <span class="text-dark fw-medium">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ†:</span>
                                <strong class="text-primary" style="font-size: 1.1rem;">@registeredCustomersCount</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3 p-2 rounded" style="background-color: white;">
                                <span class="text-dark fw-medium">Ø¹Ù…Ù„Ø§Ø¡ Ù†Ø´Ø·ÙŠÙ†:</span>
                                <strong class="text-success" style="font-size: 1.1rem;">@activeCustomersCount</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3 p-2 rounded" style="background-color: white;">
                                <span class="text-dark fw-medium">Ø­Ù…Ù„Ø§Øª Ù…Ø±Ø³Ù„Ø©:</span>
                                <strong class="text-info" style="font-size: 1.1rem;">@totalCampaignsSent</strong>
                            </div>
                            <div class="d-flex justify-content-between p-2 rounded" style="background-color: white;">
                                <span class="text-dark fw-medium">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØªØ­:</span>
                                <strong class="text-warning" style="font-size: 1.1rem;">@openRate%</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Templates -->
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                            <h6 class="mb-0 fw-bold"><i class="bi bi-file-earmark-text"></i> Ù‚ÙˆØ§Ù„Ø¨ Ø³Ø±ÙŠØ¹Ø©</h6>
                        </div>
                        <div class="card-body" style="background-color: #f8f9fa;">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm text-end fw-medium" style="border-width: 2px;" @onclick='() => ApplyQuickTemplate("welcome")'>
                                    <i class="bi bi-hand-thumbs-up"></i> ØªØ±Ø­ÙŠØ¨ Ø¨Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                                </button>
                                <button class="btn btn-outline-success btn-sm text-end fw-medium" style="border-width: 2px;" @onclick='() => ApplyQuickTemplate("offer")'>
                                    <i class="bi bi-gift"></i> Ø¹Ø±Ø¶ Ø®Ø§Øµ
                                </button>
                                <button class="btn btn-outline-warning btn-sm text-end fw-medium" style="border-width: 2px;" @onclick='() => ApplyQuickTemplate("reminder")'>
                                    <i class="bi bi-bell"></i> ØªØ°ÙƒÙŠØ±
                                </button>
                                <button class="btn btn-outline-info btn-sm text-end fw-medium" style="border-width: 2px;" @onclick='() => ApplyQuickTemplate("thankyou")'>
                                    <i class="bi bi-heart"></i> Ø´ÙƒØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Public Landing Page -->
                    <div class="card shadow-sm border-0 mb-3" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                        <div class="card-body text-white">
                            <h6 class="fw-bold mb-3" style="color: #ffffff; font-size: 1.1rem;">
                                <i class="bi bi-link-45deg"></i> Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ø¹Ø§Ù…
                            </h6>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" readonly value="https://yoursite.com/subscribe" id="subscribeLink">
                                <button class="btn btn-light" @onclick="CopySubscribeLink">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <small style="color: #e3f2fd; font-weight: 500;">
                                <i class="bi bi-info-circle"></i> Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¬Ø¯Ø¯
                            </small>
                        </div>
                    </div>

                    <!-- Tips Card -->
                    <div class="card shadow-sm border-0" style="background-color: #fff8e1; border: 2px solid #ffc107 !important;">
                        <div class="card-body">
                            <h6 class="fw-bold mb-3" style="color: #f57c00; font-size: 1.1rem;">
                                <i class="bi bi-lightbulb-fill"></i> Ù†ØµØ§Ø¦Ø­ ØªØ³ÙˆÙŠÙ‚ÙŠØ©
                            </h6>
                            <ul class="list-unstyled">
                                <li class="mb-2 text-dark fw-medium"><i class="bi bi-check-circle-fill text-success"></i> Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¬Ø°Ø§Ø¨Ø§Ù‹ ÙˆÙ…Ø®ØªØµØ±Ø§Ù‹</li>
                                <li class="mb-2 text-dark fw-medium"><i class="bi bi-check-circle-fill text-success"></i> Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„ØªØ®ØµÙŠØµ</li>
                                <li class="mb-2 text-dark fw-medium"><i class="bi bi-check-circle-fill text-success"></i> Ø£Ø¶Ù call-to-action ÙˆØ§Ø¶Ø­</li>
                                <li class="mb-2 text-dark fw-medium"><i class="bi bi-check-circle-fill text-success"></i> Ø£Ø±Ø³Ù„ ÙÙŠ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</li>
                                <li class="mb-2 text-dark fw-medium"><i class="bi bi-check-circle-fill text-success"></i> Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</li>
                                <li class="mb-2 text-dark fw-medium"><i class="bi bi-check-circle-fill text-success"></i> ØªØ§Ø¨Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ù„Ù„Ù‡Ø§</li>
                            </ul>

                            <div class="alert mb-0" style="background-color: #fff3cd; border: 2px solid #ffc107; color: #856404;">
                                <i class="bi bi-exclamation-triangle-fill"></i> 
                                <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ø¦Ù„ ØªØ³ÙˆÙŠÙ‚ÙŠØ©
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="customers-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Customer List (@customers.Count)</h5>
                    <button class="btn btn-light btn-sm" @onclick="LoadCustomers">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    @if (customers.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>WhatsApp</th>
                                        <th>Subscribed</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var customer in customers)
                                    {
                                        <tr>
                                            <td>@customer.Name</td>
                                            <td>@customer.Email</td>
                                            <td>@customer.Phone</td>
                                            <td>@customer.WhatsAppNumber</td>
                                            <td>
                                                @if (customer.SubscribedToMarketing)
                                                {
                                                    <span class="badge bg-success">Yes</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">No</span>
                                                }
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCustomer(customer.Id)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> No customers found in the list
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history-tab">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Campaign History</h5>
                    <button class="btn btn-light btn-sm" @onclick="LoadCampaigns">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    @if (campaigns.Any())
                    {
                        @foreach (var camp in campaigns)
                        {
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="fw-bold">@camp.Title</h6>
                                            <p class="text-muted mb-2">@camp.MessageContent</p>
                                            <div class="d-flex gap-3">
                                                <span class="badge bg-primary">
                                                    @(camp.Type == 1 ? "WhatsApp" : camp.Type == 2 ? "Email" : "Both")
                                                </span>
                                                <span class="badge bg-success">Sent to: @camp.SentCount</span>
                                                <small class="text-muted">@camp.SentAt?.ToString("dd/MM/yyyy hh:mm tt")</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> No campaigns sent yet
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private CampaignFormModel campaign = new();
    private List<CustomerDto> customers = new();
    private List<CampaignDto> campaigns = new();
    private bool sending = false;
    private string? campaignResult;
    private bool campaignSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
        await LoadCampaigns();
    }

    private async Task LoadCustomers()
    {
        try
        {
            customers = await Http.GetFromJsonAsync<List<CustomerDto>>("/api/marketing/customers") ?? new();
        }
        catch { }
    }

    private async Task LoadCampaigns()
    {
        try
        {
            campaigns = await Http.GetFromJsonAsync<List<CampaignDto>>("/api/marketing/campaigns") ?? new();
        }
        catch { }
    }

    private async Task SendCampaign()
    {
        sending = true;
        campaignResult = null;

        try
        {
            var response = await Http.PostAsJsonAsync("/api/marketing/send", campaign);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<SendResult>();
                campaignResult = result?.Message ?? "Campaign sent successfully";
                campaignSuccess = true;
                campaign = new();
                await LoadCampaigns();
            }
            else
            {
                campaignResult = "Failed to send campaign";
                campaignSuccess = false;
            }
        }
        catch (Exception ex)
        {
            campaignResult = $"Error: {ex.Message}";
            campaignSuccess = false;
        }
        finally
        {
            sending = false;
        }
    }

    private async Task DeleteCustomer(int id)
    {
        try
        {
            await Http.DeleteAsync($"/api/marketing/customers/{id}");
            await LoadCustomers();
        }
        catch { }
    }

    public class CampaignFormModel
    {
        public string Title { get; set; } = "";
        public string MessageContent { get; set; } = "";
        public int Type { get; set; } = 3;
        public string AudienceType { get; set; } = "registered";
        public string Channel { get; set; } = "both";
        public bool TrackClicks { get; set; } = true;
        public bool GenerateQRCode { get; set; } = false;
        public string SendTiming { get; set; } = "now";
        public DateTime? ScheduledDate { get; set; }
    }

    // Template Messages
    private Dictionary<string, string> messageTemplates = new()
    {
        ["welcome"] = "Ù…Ø±Ø­Ø¨Ø§Ù‹ {Ø§Ù„Ø§Ø³Ù…}! ğŸ‰\n\nÙ†Ø­Ù† Ø³Ø¹Ø¯Ø§Ø¡ Ø¨Ø§Ù†Ø¶Ù…Ø§Ù…Ùƒ Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ø§Ø³Ø©. Ù†Ù‚Ø¯Ù… Ù„Ùƒ Ø£ÙØ¶Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø­ØµØ±ÙŠØ©.\n\nØ²Ø± Ù…ÙˆÙ‚Ø¹Ù†Ø§: {Ø±Ø§Ø¨Ø·_Ø§Ù„Ù…ÙˆÙ‚Ø¹}",
        ["offer"] = "Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„Ùƒ {Ø§Ù„Ø§Ø³Ù…}! ğŸ\n\nØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 20% Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø®Ø¯Ù…Ø§ØªÙ†Ø§ Ù„ÙØªØ±Ø© Ù…Ø­Ø¯ÙˆØ¯Ø©!\n\nØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯: SPECIAL20\nØ§Ù„Ø±Ø§Ø¨Ø·: {Ø±Ø§Ø¨Ø·_Ø§Ù„Ø¹Ø±Ø¶}",
        ["reminder"] = "ØªØ°ÙƒÙŠØ± {Ø§Ù„Ø§Ø³Ù…} ğŸ””\n\nÙ„Ø§ ØªÙ†Ø³Ù! Ù„Ø¯ÙŠÙƒ Ø¹Ø±Ø¶ Ø­ØµØ±ÙŠ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹.\n\nØ´Ø§Ù‡Ø¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {Ø±Ø§Ø¨Ø·_Ø§Ù„Ù…ÙˆÙ‚Ø¹}",
        ["thankyou"] = "Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ {Ø§Ù„Ø§Ø³Ù…}! â¤ï¸\n\nÙ†Ù‚Ø¯Ø± Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§. Ø·Ù„Ø¨Ùƒ Ø±Ù‚Ù… #{Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨} Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°.\n\nØªØ§Ø¨Ø¹ Ø·Ù„Ø¨Ùƒ: {Ø±Ø§Ø¨Ø·_Ø§Ù„Ù…ÙˆÙ‚Ø¹}",
        ["abandoned"] = "Ù†Ù„Ø§Ø­Ø¸ Ø£Ù†Ùƒ ØªØ±ÙƒØª Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ {Ø§Ù„Ø§Ø³Ù…} ğŸ›’\n\nØ£ÙƒÙ…Ù„ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 10%!\n\nØ§Ø±Ø¬Ø¹ Ù„Ù„Ø³Ù„Ø©: {Ø±Ø§Ø¨Ø·_Ø§Ù„Ø³Ù„Ø©}"
    };

    private string selectedTemplate = "";
    private int registeredCustomersCount = 0;
    private int activeCustomersCount = 0;
    private int inactiveCustomersCount = 0;
    private int totalCampaignsSent = 0;
    private double openRate = 0;

    private void LoadTemplate()
    {
        if (!string.IsNullOrEmpty(selectedTemplate) && messageTemplates.ContainsKey(selectedTemplate))
        {
            campaign.MessageContent = messageTemplates[selectedTemplate];
        }
    }

    private void ApplyQuickTemplate(string templateKey)
    {
        selectedTemplate = templateKey;
        LoadTemplate();
    }

    private async Task SaveDraft()
    {
        // Ø­ÙØ¸ Ø§Ù„Ø­Ù…Ù„Ø© ÙƒÙ…Ø³ÙˆØ¯Ø©
        try
        {
            await Http.PostAsJsonAsync("/api/marketing/draft", campaign);
            campaignResult = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­";
            campaignSuccess = true;
        }
        catch (Exception ex)
        {
            campaignResult = $"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©: {ex.Message}";
            campaignSuccess = false;
        }
    }

    private void PreviewCampaign()
    {
        // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ø­Ù…Ù„Ø©
        var previewMessage = campaign.MessageContent
            .Replace("{Ø§Ù„Ø§Ø³Ù…}", "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯")
            .Replace("{Ø§Ù„Ø¨Ø±ÙŠØ¯}", "ahmed@example.com")
            .Replace("{Ø±Ù‚Ù…_Ø§Ù„Ù‡Ø§ØªÙ}", "0501234567")
            .Replace("{Ø±Ø§Ø¨Ø·_Ø§Ù„Ù…ÙˆÙ‚Ø¹}", "https://yoursite.com")
            .Replace("{Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}", "12345")
            .Replace("{Ø±Ø§Ø¨Ø·_Ø§Ù„Ø¹Ø±Ø¶}", "https://yoursite.com/offer")
            .Replace("{Ø±Ø§Ø¨Ø·_Ø§Ù„Ø³Ù„Ø©}", "https://yoursite.com/cart");
        
        campaignResult = $"Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\n\n{previewMessage}";
        campaignSuccess = true;
    }

    private async Task CopySubscribeLink()
    {
        // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", "https://yoursite.com/subscribe");
            campaignResult = "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!";
            campaignSuccess = true;
        }
        catch { }
    }

    private void ShareToFacebook()
    {
        var url = $"https://www.facebook.com/sharer/sharer.php?u={"https://yoursite.com"}&quote={campaign.Title}";
        JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }

    private void ShareToTwitter()
    {
        var url = $"https://twitter.com/intent/tweet?text={campaign.Title}&url={"https://yoursite.com"}";
        JSRuntime.InvokeVoidAsync("open", url, "_blank");
    }

    private void ShareToInstagram()
    {
        campaignResult = "Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªÙ‚Ø±Ø§Ù…: Ø§Ø³ØªØ®Ø¯Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©";
        campaignSuccess = true;
    }

    public class CustomerDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string? Phone { get; set; }
        public string? WhatsAppNumber { get; set; }
        public bool SubscribedToMarketing { get; set; }
    }

    public class CampaignDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string MessageContent { get; set; } = "";
        public int Type { get; set; }
        public int SentCount { get; set; }
        public DateTime? SentAt { get; set; }
    }

    public class SendResult
    {
        public string? Message { get; set; }
        public int SentCount { get; set; }
    }
}
