@page "/admin/orders"
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@attribute [Authorize(Policy = "AdminOnly")]

<PageTitle>إدارة الطلبيات - لوحة التحكم</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="display-5">
                    <i class="bi bi-cart-check"></i> إدارة الطلبيات
                </h1>
                <div class="text-end">
                    <small class="text-muted d-block mb-2">إجمالي الطلبيات: <strong>@orders.Count</strong></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                                <i class="bi bi-cart fs-3 text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-0">إجمالي الطلبيات</h6>
                            <h3 class="mb-0">@orders.Count</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                                <i class="bi bi-hourglass-split fs-3 text-warning"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-0">قيد المعالجة</h6>
                            <h3 class="mb-0">@orders.Count(o => o.Status == OrderStatus.Pending || o.Status == OrderStatus.Processing)</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-success bg-opacity-10 p-3">
                                <i class="bi bi-check-circle fs-3 text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-0">مكتملة</h6>
                            <h3 class="mb-0">@orders.Count(o => o.Status == OrderStatus.Completed)</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-danger bg-opacity-10 p-3">
                                <i class="bi bi-x-circle fs-3 text-danger"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="text-muted mb-0">ملغاة</h6>
                            <h3 class="mb-0">@orders.Count(o => o.Status == OrderStatus.Cancelled)</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">حالة الطلبية</label>
                    <select class="form-select" @onchange="@((ChangeEventArgs e) => FilterByStatus((string)e.Value))">
                        <option value="">جميع الحالات</option>
                        <option value="Pending">قيد الانتظار</option>
                        <option value="Processing">قيد المعالجة</option>
                        <option value="Completed">مكتملة</option>
                        <option value="Cancelled">ملغاة</option>
                        <option value="Refunded">مسترجعة</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">حالة الدفع</label>
                    <select class="form-select" @onchange="@((ChangeEventArgs e) => FilterByPaymentStatus((string)e.Value))">
                        <option value="">جميع الحالات</option>
                        <option value="Pending">قيد الانتظار</option>
                        <option value="Paid">مدفوع</option>
                        <option value="Failed">فشل</option>
                        <option value="Refunded">مسترجع</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">البحث</label>
                    <input type="text" class="form-control" placeholder="ابحث برقم الطلبية أو اسم العميل..." 
                        @oninput="@((ChangeEventArgs e) => SearchOrders((string)e.Value))" />
                </div>
            </div>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
        </div>
    }
    else if (filteredOrders == null || !filteredOrders.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle fs-3"></i>
            <p class="mt-2 mb-0">لا توجد طلبيات.</p>
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>رقم الطلبية</th>
                                <th>العميل</th>
                                <th>التاريخ</th>
                                <th>المبلغ الإجمالي</th>
                                <th>الخصم</th>
                                <th>المبلغ النهائي</th>
                                <th>حالة الطلبية</th>
                                <th>حالة الدفع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in filteredOrders)
                            {
                                <tr>
                                    <td>
                                        <strong>#@order.OrderNumber</strong>
                                    </td>
                                    <td>
                                        <strong>@order.UserName</strong>
                                    </td>
                                    <td>
                                        @order.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                    <td>
                                        @order.TotalAmount.ToString("N0") SAR
                                    </td>
                                    <td>
                                        @if (order.DiscountAmount > 0)
                                        {
                                            <span class="badge bg-info">@order.DiscountAmount.ToString("N0") SAR</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <strong class="text-success">@order.FinalAmount.ToString("N0") SAR</strong>
                                    </td>
                                    <td>
                                        @switch (order.Status)
                                        {
                                            case OrderStatus.Pending:
                                                <span class="badge bg-warning">قيد الانتظار</span>
                                                break;
                                            case OrderStatus.Processing:
                                                <span class="badge bg-info">قيد المعالجة</span>
                                                break;
                                            case OrderStatus.Completed:
                                                <span class="badge bg-success">مكتملة</span>
                                                break;
                                            case OrderStatus.Cancelled:
                                                <span class="badge bg-danger">ملغاة</span>
                                                break;
                                            case OrderStatus.Refunded:
                                                <span class="badge bg-secondary">مسترجعة</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        @switch (order.PaymentStatus)
                                        {
                                            case PaymentStatus.Pending:
                                                <span class="badge bg-warning">قيد الانتظار</span>
                                                break;
                                            case PaymentStatus.Paid:
                                                <span class="badge bg-success">مدفوع</span>
                                                break;
                                            case PaymentStatus.Failed:
                                                <span class="badge bg-danger">فشل</span>
                                                break;
                                            case PaymentStatus.Refunded:
                                                <span class="badge bg-secondary">مسترجع</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @onclick="() => ViewOrderDetails(order.Id)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        @if (order.Status != OrderStatus.Completed && order.Status != OrderStatus.Cancelled)
                                        {
                                            <button class="btn btn-sm btn-warning" @onclick="() => UpdateOrderStatus(order)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تفاصيل الطلبية #@selectedOrder?.OrderNumber</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @if (selectedOrder != null)
                {
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>رقم الطلبية:</strong> #@selectedOrder.OrderNumber</p>
                            <p><strong>العميل:</strong> @selectedOrder.UserName</p>
                            <p><strong>التاريخ:</strong> @selectedOrder.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>حالة الطلبية:</strong> <span class="badge bg-info">@selectedOrder.Status</span></p>
                            <p><strong>حالة الدفع:</strong> <span class="badge bg-info">@selectedOrder.PaymentStatus</span></p>
                            @if (!string.IsNullOrEmpty(selectedOrder.CouponCode))
                            {
                                <p><strong>كود الخصم:</strong> @selectedOrder.CouponCode</p>
                            }
                        </div>
                    </div>

                    <hr />

                    <h6 class="fw-bold mb-3">تفاصيل الخدمات:</h6>
                    <div class="table-responsive mb-3">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>الخدمة</th>
                                    <th>الكمية</th>
                                    <th>السعر الوحدة</th>
                                    <th>الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in selectedOrder.OrderItems)
                                {
                                    <tr>
                                        <td>@item.ProductNameAr</td>
                                        <td>@item.Quantity</td>
                                        <td>@item.UnitPrice.ToString("N0") SAR</td>
                                        <td>@item.TotalPrice.ToString("N0") SAR</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="row">
                        <div class="col-md-6 ms-auto">
                            <p><strong>المبلغ الإجمالي:</strong> @selectedOrder.TotalAmount.ToString("N0") SAR</p>
                            @if (selectedOrder.DiscountAmount > 0)
                            {
                                <p><strong>الخصم:</strong> -@selectedOrder.DiscountAmount.ToString("N0") SAR</p>
                            }
                            <p class="fw-bold fs-5"><strong>المبلغ النهائي:</strong> @selectedOrder.FinalAmount.ToString("N0") SAR</p>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(selectedOrder.Notes))
                    {
                        <hr />
                        <p><strong>ملاحظات:</strong> @selectedOrder.Notes</p>
                    }
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

@code {
    private List<OrderDto> orders = new();
    private List<OrderDto> filteredOrders = new();
    private OrderDto? selectedOrder;
    private bool loading = true;
    private string selectedStatusFilter = "";
    private string selectedPaymentStatusFilter = "";
    private string searchQuery = "";

    [Inject] private HttpClient Http { get; set; } = default!;
    [Inject] private ILogger<Orders> Logger { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        loading = true;
        try
        {
            // This would call an API endpoint if it exists
            // For now, we'll use a placeholder
            var response = await Http.GetAsync("/api/orders");
            if (response.IsSuccessStatusCode)
            {
                orders = await response.Content.ReadFromJsonAsync<List<OrderDto>>() ?? new();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // API not implemented yet
                orders = new();
            }
            
            filteredOrders = orders;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading orders");
            orders = new();
            filteredOrders = new();
        }
        finally
        {
            loading = false;
        }
    }

    private void FilterByStatus(string status)
    {
        selectedStatusFilter = status;
        ApplyFilters();
    }

    private void FilterByPaymentStatus(string paymentStatus)
    {
        selectedPaymentStatusFilter = paymentStatus;
        ApplyFilters();
    }

    private void SearchOrders(string query)
    {
        searchQuery = query;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredOrders = orders;

        if (!string.IsNullOrEmpty(selectedStatusFilter))
        {
            filteredOrders = filteredOrders.Where(o => o.Status.ToString() == selectedStatusFilter).ToList();
        }

        if (!string.IsNullOrEmpty(selectedPaymentStatusFilter))
        {
            filteredOrders = filteredOrders.Where(o => o.PaymentStatus.ToString() == selectedPaymentStatusFilter).ToList();
        }

        if (!string.IsNullOrEmpty(searchQuery))
        {
            var query = searchQuery.ToLower();
            filteredOrders = filteredOrders.Where(o => 
                o.OrderNumber.ToLower().Contains(query) || 
                o.UserName.ToLower().Contains(query)
            ).ToList();
        }

        StateHasChanged();
    }

    private async Task ViewOrderDetails(int orderId)
    {
        selectedOrder = orders.FirstOrDefault(o => o.Id == orderId);
        if (selectedOrder != null)
        {
            await InvokeAsync(() => 
            {
                var js = (IJSRuntime)Http.BaseAddress; // This is a workaround; normally you'd inject IJSRuntime
                // For now, we'll just show it works by setting the order
            });
        }
    }

    private async Task UpdateOrderStatus(OrderDto order)
    {
        // This would open a modal or update the order status
        Logger.LogInformation($"Update order {order.Id}");
    }

    public class OrderDto
    {
        public int Id { get; set; }
        public string OrderNumber { get; set; } = null!;
        public string UserId { get; set; } = null!;
        public string UserName { get; set; } = null!;
        public decimal TotalAmount { get; set; }
        public decimal DiscountAmount { get; set; }
        public decimal FinalAmount { get; set; }
        public OrderStatus Status { get; set; }
        public PaymentStatus PaymentStatus { get; set; }
        public string? Notes { get; set; }
        public string? CouponCode { get; set; }
        public DateTime CreatedAt { get; set; }
        public List<OrderItemDto> OrderItems { get; set; } = new();
    }

    public class OrderItemDto
    {
        public int Id { get; set; }
        public int ProductId { get; set; }
        public string ProductNameAr { get; set; } = null!;
        public string ProductNameEn { get; set; } = null!;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal TotalPrice { get; set; }
        public decimal DiscountAmount { get; set; }
    }

    public enum OrderStatus
    {
        Pending,
        Processing,
        Completed,
        Cancelled,
        Refunded
    }

    public enum PaymentStatus
    {
        Pending,
        Paid,
        Failed,
        Refunded
    }
}
